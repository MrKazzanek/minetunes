<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator plików JS/JSON</title>
    <style>
        :root {
            --primary-bg: #1e1e1e;
            --secondary-bg: #2d2d2d;
            --tertiary-bg: #3c3c3c;
            --text-color: #dcdcdc;
            --primary-color: #4a90e2;
            --border-color: #555;
            --success-color: #5cb85c;
            --danger-color: #d9534f;
            --warning-color: #f0ad4e;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--primary-bg);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--secondary-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        h1, h2, h3 {
            color: #fff;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 0;
        }

        .section {
            background-color: var(--tertiary-bg);
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 25px;
        }
        
        .warning-box {
            background-color: rgba(240, 173, 78, 0.1);
            border-left: 4px solid var(--warning-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            background-color: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-color);
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input[readonly] {
            background-color: #333;
            cursor: not-allowed;
        }

        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: "Courier New", Courier, monospace;
            font-size: 14px;
        }

        button {
            display: inline-block;
            width: auto;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            color: #fff;
            background-color: var(--primary-color);
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button.full-width {
            width: 100%;
        }

        button:hover {
            background-color: #5aa1f2;
        }
        
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Generator Obiektów JavaScript</h1>

        <!-- SEKCJA 0: WCZYTYWANIE DANYCH -->
        <div id="dataLoaderSection" class="section">
            <h2>Wczytywanie danych...</h2>
            <div id="manualDataLoader" class="hidden">
                 <div class="warning-box">
                    <p><strong>Automatyczne wczytywanie plików nie powiodło się.</strong></p>
                    <p>Proszę wkleić zawartość swoich plików poniżej, a następnie kliknąć przycisk "Przetwórz Dane".</p>
                </div>
                <div class="grid">
                    <div>
                        <label for="existingSongsJson">songs.js / songs.json</label>
                        <textarea id="existingSongsJson"></textarea>
                    </div>
                    <div>
                        <label for="existingAlbumsJson">albums.js / albums.json</label>
                        <textarea id="existingAlbumsJson"></textarea>
                    </div>
                </div>
                <button id="loadManualDataBtn" class="full-width">Przetwórz Dane</button>
            </div>
        </div>

        <!-- Główna zawartość aplikacji, początkowo ukryta -->
        <div id="appContent" class="hidden">
            <!-- SEKCJA 1: DODAWANIE UTWORU -->
            <div class="section">
                <h2>1. Dodaj Nowy Utwór</h2>
                <div id="songForm" class="grid">
                     <div>
                        <label for="songArtist">Nazwa autora</label>
                        <input type="text" id="songArtist" placeholder="np. Amos Roddy">
                    </div>
                    <div>
                        <label for="songTitle">Nazwa muzyki</label>
                        <input type="text" id="songTitle" placeholder="np. Sigma Boy">
                    </div>
                    <div class="full-width">
                        <label for="songId">Wygenerowane ID (tylko do odczytu)</label>
                        <input type="text" id="songId" readonly>
                    </div>
                    <div>
                        <label for="songSrc">Nazwa pliku muzycznego (w folderze /music)</label>
                        <input type="text" id="songSrc" placeholder="np. sigma_boy.mp3">
                    </div>
                    <div>
                        <label for="songCover">Nazwa pliku okładki (w folderze /images)</label>
                        <input type="text" id="songCover" placeholder="np. sigma_boy.jpg">
                    </div>
                    <div>
                        <label for="songGenre">Gatunek (oddzielone przecinkami)</label>
                        <input type="text" id="songGenre" placeholder="np. Electronic, Chill">
                    </div>
                    <div>
                        <label for="songVersion">Wersja dodania</label>
                        <input type="text" id="songVersion" placeholder="np. 1.21">
                    </div>
                    <div class="full-width">
                        <label for="songDuration">Czas trwania (w sekundach)</label>
                        <input type="number" id="songDuration" placeholder="np. 180">
                    </div>
                </div>
            </div>

            <!-- SEKCJA 2: OPCJE ALBUMU -->
            <div class="section">
                <h2>2. Opcje Albumu</h2>
                <div id="albumOptions" class="radio-group">
                    <label><input type="radio" name="albumAction" value="none" checked> a) Nie dodawaj do albumu</label>
                    <label><input type="radio" name="albumAction" value="existing"> b) Dodaj do istniejącego albumu</label>
                    <label><input type="radio" name="albumAction" value="new"> c) Utwórz nowy album i przypisz utwór</label>
                    <label><input type="radio" name="albumAction" value="manage"> d) Zarządzaj albumami (bez dodawania utworu)</label>
                </div>

                <div id="actionExisting" class="sub-section hidden">
                    <h3>b) Wybierz istniejący album</h3>
                    <select id="existingAlbumsSelect"></select>
                </div>

                <div id="actionNew" class="sub-section hidden">
                    <h3>c) Utwórz nowy album</h3>
                    <label for="newAlbumTitle">Tytuł albumu (wymagane)</label>
                    <input type="text" id="newAlbumTitle" placeholder="np. Nowe Hity">
                    <label for="newAlbumDesc">Opis (opcjonalnie)</label>
                    <input type="text" id="newAlbumDesc">
                    <label for="newAlbumCover">Okładka (w folderze /album-images, opcjonalnie)</label>
                    <input type="text" id="newAlbumCover" placeholder="np. hity.png">
                    <label>Dodaj również inne istniejące utwory:</label>
                    <div id="newAlbumSongList" class="song-list"></div>
                </div>

                <div id="actionManage" class="sub-section hidden">
                    <h3>d) Zarządzaj albumami</h3>
                    <p style="color: #ffcc00;">Uwaga: Wybranie tej opcji sprawi, że formularz dodawania utworu powyżej zostanie zignorowany.</p>
                    <select id="manageAlbumSelect"></select>
                    <div id="manageAlbumForm">
                        <label for="manageAlbumTitle">Tytuł albumu</label>
                        <input type="text" id="manageAlbumTitle">
                        <label for="manageAlbumDesc">Opis</label>
                        <input type="text" id="manageAlbumDesc">
                        <label for="manageAlbumCover">Okładka</label>
                        <input type="text" id="manageAlbumCover">
                        <label>Wybierz utwory dla tego albumu:</label>
                        <div id="manageAlbumSongList" class="song-list"></div>
                    </div>
                    <div id="deleteAlbumSection" class="hidden">
                        <label for="deleteAlbumSelect">Wybierz album do usunięcia:</label>
                        <select id="deleteAlbumSelect"></select>
                    </div>
                </div>
            </div>

            <!-- SEKCJA 3: GENEROWANIE -->
            <div class="section">
                <h2>3. Generuj Kod</h2>
                <button id="generateBtn" class="full-width">Generuj kod</button>
            </div>

            <!-- SEKCJA 4: WYNIK -->
            <div class="section">
                <h2>Wynik</h2>
                <div class="grid">
                    <div>
                        <div class="output-header">
                            <label for="outputSongsJs">Zawartość dla <u>songs.js</u></label>
                            <button id="downloadSongsBtn" disabled>Pobierz</button>
                        </div>
                        <textarea id="outputSongsJs" readonly></textarea>
                    </div>
                    <div>
                        <div class="output-header">
                            <label for="outputAlbumsJs">Zawartość dla <u>albums.js</u></label>
                            <button id="downloadAlbumsBtn" disabled>Pobierz</button>
                        </div>
                        <textarea id="outputAlbumsJs" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let songsData = [];
        let albumsData = [];

        const dom = {
            dataLoaderSection: document.getElementById('dataLoaderSection'),
            manualDataLoader: document.getElementById('manualDataLoader'),
            existingSongsJson: document.getElementById('existingSongsJson'),
            existingAlbumsJson: document.getElementById('existingAlbumsJson'),
            loadManualDataBtn: document.getElementById('loadManualDataBtn'),
            appContent: document.getElementById('appContent'),
            songArtist: document.getElementById('songArtist'),
            songTitle: document.getElementById('songTitle'),
            songId: document.getElementById('songId'),
            songSrc: document.getElementById('songSrc'),
            songCover: document.getElementById('songCover'),
            songGenre: document.getElementById('songGenre'),
            songVersion: document.getElementById('songVersion'),
            songDuration: document.getElementById('songDuration'),
            albumOptions: document.querySelectorAll('input[name="albumAction"]'),
            actionExisting: document.getElementById('actionExisting'),
            actionNew: document.getElementById('actionNew'),
            actionManage: document.getElementById('actionManage'),
            existingAlbumsSelect: document.getElementById('existingAlbumsSelect'),
            newAlbumTitle: document.getElementById('newAlbumTitle'),
            newAlbumDesc: document.getElementById('newAlbumDesc'),
            newAlbumCover: document.getElementById('newAlbumCover'),
            newAlbumSongList: document.getElementById('newAlbumSongList'),
            manageAlbumSelect: document.getElementById('manageAlbumSelect'),
            manageAlbumForm: document.getElementById('manageAlbumForm'),
            manageAlbumTitle: document.getElementById('manageAlbumTitle'),
            manageAlbumDesc: document.getElementById('manageAlbumDesc'),
            manageAlbumCover: document.getElementById('manageAlbumCover'),
            manageAlbumSongList: document.getElementById('manageAlbumSongList'),
            deleteAlbumSection: document.getElementById('deleteAlbumSection'),
            deleteAlbumSelect: document.getElementById('deleteAlbumSelect'),
            generateBtn: document.getElementById('generateBtn'),
            outputSongsJs: document.getElementById('outputSongsJs'),
            outputAlbumsJs: document.getElementById('outputAlbumsJs'),
            downloadSongsBtn: document.getElementById('downloadSongsBtn'),
            downloadAlbumsBtn: document.getElementById('downloadAlbumsBtn'),
        };
        
        function createSlugPart(str) {
            if (!str) return '';
            const a = 'àáâäæãåāăąçćčđďèéêëēėęěğǵḧîïíīįìłḿñńǹňôöòóœøōõőṕŕřßśšşșťțûüùúūǘůűųẃẍÿýžźż';
            const b = 'aaaaaaaaaacccddeeeeeeeegghiiiiiilmnnnnoooooooooprrsssssttuuuuuuuuuwxyyzzz';
            const p = new RegExp(a.split('').join('|'), 'g');
            let slug = str.toString().toLowerCase();
            slug = slug.replace(p, c => b.charAt(a.indexOf(c)));
            slug = slug.replace(/\s+/g, '_');
            slug = slug.replace(/[^\w_]+/g, '');
            slug = slug.replace(/__+/g, '_');
            slug = slug.replace(/^_+|_+$/g, '');
            return slug;
        }

        function generateSongId() {
            const artistSlug = createSlugPart(dom.songArtist.value);
            const titleSlug = createSlugPart(dom.songTitle.value);
            dom.songId.value = `${artistSlug}-${titleSlug}`;
        }
        
        function createDownloadLink(filename, content) {
            const blob = new Blob([content], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        function convertJsObjectToJson(jsObjectString) {
            if (!jsObjectString) return '';
            return jsObjectString.replace(/([{,]\s*)(\w+)(\s*:)/g, '$1"$2"$3');
        }

        function cleanJsonInput(rawText) {
            if (!rawText) return '';
            let text = rawText.trim();
            const firstBracket = text.indexOf('[');
            const firstBrace = text.indexOf('{');
            let startIndex = 0;
            if (firstBracket > -1 && firstBrace > -1) { startIndex = Math.min(firstBracket, firstBrace); } 
            else if (firstBracket > -1) { startIndex = firstBracket; } 
            else if (firstBrace > -1) { startIndex = firstBrace; }
            text = text.substring(startIndex);
            if (text.endsWith(';')) { text = text.slice(0, -1); }
            return text.trim();
        }

        /**
         * NOWA FUNKCJA: Formatuje obiekt danych do stringa w formacie pliku JS.
         * @param {object} data - Tablica obiektów do sformatowania.
         * @param {string} variableName - Nazwa zmiennej (np. 'songs').
         * @returns {string} - Sformatowany string gotowy do wklejenia do pliku .js.
         */
        function formatForJsFile(data, variableName) {
            // Krok 1: Stwórz poprawny string JSON z wcięciami
            const jsonString = JSON.stringify(data, null, 4);
            // Krok 2: Usuń cudzysłowy z kluczy
            const jsObjectString = jsonString.replace(/"([^"]+)":/g, '$1:');
            // Krok 3: Dodaj deklarację zmiennej i średnik
            return `const ${variableName} = ${jsObjectString};`;
        }

        function initializeApp() {
            dom.dataLoaderSection.classList.add('hidden');
            dom.appContent.classList.remove('hidden');
            updateUI();
        }
        
        function loadManualData() {
            try {
                let songsText = convertJsObjectToJson(dom.existingSongsJson.value);
                let albumsText = convertJsObjectToJson(dom.existingAlbumsJson.value);
                songsText = cleanJsonInput(songsText) || '[]';
                albumsText = cleanJsonInput(albumsText) || '[]';
                songsData = JSON.parse(songsText);
                albumsData = JSON.parse(albumsText);
                initializeApp();
            } catch (error) {
                 alert('Błąd parsowania danych! Sprawdź, czy dane nie mają innych błędów składni (np. brakującego przecinka).\n\n' + error);
            }
        }

        async function loadInitialData() {
            try {
                const [songsResponse, albumsResponse] = await Promise.all([
                    fetch('songs.json', { cache: 'no-store' }),
                    fetch('albums.json', { cache: 'no-store' })
                ]);
                if (!songsResponse.ok) throw new Error(`Nie udało się wczytać songs.json`);
                if (!albumsResponse.ok) throw new Error(`Nie udało się wczytać albums.json`);
                songsData = await songsResponse.json();
                albumsData = await albumsResponse.json();
                initializeApp();
            } catch (error) {
                console.error('Automatyczne wczytywanie danych nie powiodło się:', error);
                dom.manualDataLoader.classList.remove('hidden');
            }
        }
        
        function updateUI() {
            const albumOptionsHTML = albumsData.map(album => `<option value="${album.id}">${album.title}</option>`).join('');
            dom.existingAlbumsSelect.innerHTML = albumOptionsHTML;
            dom.deleteAlbumSelect.innerHTML = albumOptionsHTML;
            const manageSelectHTML = `
                <option value="--create--">-- UTWÓRZ NOWY ALBUM --</option>
                <option value="--delete--">-- USUŃ ISTNIEJĄCY ALBUM --</option>
                <optgroup label="Edytuj istniejący album">
                    ${albumOptionsHTML}
                </optgroup>`;
            dom.manageAlbumSelect.innerHTML = manageSelectHTML;
            const songCheckboxesHTML = songsData.map(song => `
                <div><label><input type="checkbox" name="songSelection" value="${song.id}"> ${song.artist} - ${song.title}</label></div>`
            ).join('');
            dom.newAlbumSongList.innerHTML = songCheckboxesHTML;
            dom.manageAlbumSongList.innerHTML = songCheckboxesHTML;
            handleManageAlbumChange();
        }
        
        function handleAlbumOptionChange() {
            const selectedAction = document.querySelector('input[name="albumAction"]:checked').value;
            dom.actionExisting.classList.toggle('hidden', selectedAction !== 'existing');
            dom.actionNew.classList.toggle('hidden', selectedAction !== 'new');
            dom.actionManage.classList.toggle('hidden', selectedAction !== 'manage');
        }
        
        function handleManageAlbumChange() {
            const selectedId = dom.manageAlbumSelect.value;
            dom.manageAlbumForm.classList.toggle('hidden', selectedId === '--delete--');
            dom.deleteAlbumSection.classList.toggle('hidden', selectedId !== '--delete--');
            const allCheckboxes = dom.manageAlbumSongList.querySelectorAll('input[type="checkbox"]');
            allCheckboxes.forEach(cb => cb.checked = false);
            if (selectedId === '--create--' || selectedId === '--delete--') {
                dom.manageAlbumTitle.value = '';
                dom.manageAlbumDesc.value = '';
                dom.manageAlbumCover.value = '';
            } else {
                const album = albumsData.find(a => a.id === selectedId);
                if (album) {
                    dom.manageAlbumTitle.value = album.title;
                    dom.manageAlbumDesc.value = album.description || '';
                    dom.manageAlbumCover.value = album.cover || '';
                    album.songs.forEach(songId => {
                        const checkbox = dom.manageAlbumSongList.querySelector(`input[value="${songId}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            }
        }
        
        function generateCode() {
            let newSongs = JSON.parse(JSON.stringify(songsData));
            let newAlbums = JSON.parse(JSON.stringify(albumsData));
            const selectedAction = document.querySelector('input[name="albumAction"]:checked').value;
            if (['none', 'existing', 'new'].includes(selectedAction)) {
                if (!dom.songArtist.value || !dom.songTitle.value || !dom.songId.value) {
                    alert('Nazwa autora i muzyki są wymagane do utworzenia piosenki!'); return;
                }
                const newSong = { id: dom.songId.value, title: dom.songTitle.value, artist: dom.songArtist.value, src: dom.songSrc.value ? `music/${dom.songSrc.value}` : '', cover: dom.songCover.value ? `images/${dom.songCover.value}`: '', genre: dom.songGenre.value.split(',').map(g => g.trim()).filter(Boolean), version: dom.songVersion.value, duration: parseInt(dom.songDuration.value, 10) || 0 };
                newSongs.push(newSong);
                switch (selectedAction) {
                    case 'existing':
                        const targetAlbum = newAlbums.find(a => a.id === dom.existingAlbumsSelect.value);
                        if (targetAlbum) { targetAlbum.songs.push(newSong.id); }
                        break;
                    case 'new':
                        if (!dom.newAlbumTitle.value) { alert('Tytuł nowego albumu jest wymagany!'); return; }
                        const newAlbum = { id: createSlugPart(dom.newAlbumTitle.value).replace(/_/g, '-'), title: dom.newAlbumTitle.value, description: dom.newAlbumDesc.value || '', cover: dom.newAlbumCover.value ? `album-images/${dom.newAlbumCover.value}` : '', songs: [newSong.id, ...Array.from(dom.newAlbumSongList.querySelectorAll('input:checked')).map(cb => cb.value)] };
                        newAlbums.push(newAlbum);
                        break;
                }
            } else if (selectedAction === 'manage') {
                const manageAction = dom.manageAlbumSelect.value;
                if (manageAction === '--create--') {
                    if (!dom.manageAlbumTitle.value) { alert('Tytuł nowego albumu jest wymagany!'); return; }
                    const newAlbum = { id: createSlugPart(dom.manageAlbumTitle.value).replace(/_/g, '-'), title: dom.manageAlbumTitle.value, description: dom.manageAlbumDesc.value, cover: dom.manageAlbumCover.value, songs: Array.from(dom.manageAlbumSongList.querySelectorAll('input:checked')).map(cb => cb.value) };
                    newAlbums.push(newAlbum);
                } else if (manageAction === '--delete--') {
                     const albumToDelete = albumsData.find(a => a.id === dom.deleteAlbumSelect.value);
                     if (albumToDelete && confirm(`Czy na pewno chcesz usunąć album "${albumToDelete.title}"?`)) {
                        newAlbums = newAlbums.filter(a => a.id !== albumToDelete.id);
                     }
                } else {
                    const albumToEdit = newAlbums.find(a => a.id === manageAction);
                    if (albumToEdit) {
                        albumToEdit.title = dom.manageAlbumTitle.value; albumToEdit.id = createSlugPart(albumToEdit.title).replace(/_/g, '-'); albumToEdit.description = dom.manageAlbumDesc.value; albumToEdit.cover = dom.manageAlbumCover.value; albumToEdit.songs = Array.from(dom.manageAlbumSongList.querySelectorAll('input:checked')).map(cb => cb.value);
                    }
                }
            }
            // Użyj nowej funkcji do formatowania wyniku
            dom.outputSongsJs.value = formatForJsFile(newSongs, 'songs');
            dom.outputAlbumsJs.value = formatForJsFile(newAlbums, 'albums');
            dom.downloadSongsBtn.disabled = false;
            dom.downloadAlbumsBtn.disabled = false;
        }

        window.addEventListener('DOMContentLoaded', () => {
            dom.loadManualDataBtn.addEventListener('click', loadManualData);
            dom.songArtist.addEventListener('input', generateSongId);
            dom.songTitle.addEventListener('input', generateSongId);
            dom.albumOptions.forEach(radio => radio.addEventListener('change', handleAlbumOptionChange));
            dom.manageAlbumSelect.addEventListener('change', handleManageAlbumChange);
            dom.generateBtn.addEventListener('click', generateCode);
            // Zaktualizuj nazwy plików do pobrania
            dom.downloadSongsBtn.addEventListener('click', () => createDownloadLink('songs.js', dom.outputSongsJs.value));
            dom.downloadAlbumsBtn.addEventListener('click', () => createDownloadLink('albums.js', dom.outputAlbumsJs.value));
            loadInitialData();
        });
    </script>
</body>
</html>
